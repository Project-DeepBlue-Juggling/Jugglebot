---
- name: Provision the WSL2 host
  hosts: localhost
  connection: local

  tasks:

  - name: Specify the environments directory
    set_fact:
      environments_dir: "{{ playbook_dir }}/.."

  - name: Load variables
    include_vars: "{{ environments_dir }}/ubuntu_24.04-wsl2/main_vars.yml"

  - name: Ensure that wsl uses systemd
    # Note: Systemd is enabled by default, but this will change whitespace
    community.general.ini_file:
      path: '/etc/wsl.conf'
      section: 'boot'
      option: 'systemd'
      value: 'true'
    become: yes

  - name: Prevent wsl from changing resolv.conf
    community.general.ini_file:
      path: '/etc/wsl.conf'
      section: 'network'
      option: 'generateResolvConf'
      value: 'false'
    become: yes

  - name: Provision the Ubuntu environment
    import_tasks: "{{ environments_dir }}/ubuntu-common/dev_env_tasks.yml"
    vars:
      environments_dir: "{{ playbook_dir }}/.."

  - name: Add an ssh config for GitHub
    community.general.ssh_config:
      user: "{{ username }}"
      host: 'github.com'
      hostname: 'github.com'
      remote_user: 'git'
      identity_file: "~/.ssh/{{ ssh_keypair_name }}"
      identities_only: yes
      add_keys_to_agent: yes
      strict_host_key_checking: accept-new

  - name: Ensure that the Jugglebot repo has been cloned
    git:
      repo: "{{ jugglebot_repo_ssh_url }}"
      dest: "{{ jugglebot_repo_dir }}"

  - name: Add the Docker package repository
    import_tasks: "{{ environments_dir }}/ubuntu-common/docker_repository_tasks.hml"
    vars:
      environments_dir: "{{ playbook_dir }}/.."

  - name: Provision the Docker Engine & Qemu
    import_tasks: "{{ environments_dir }}/ubuntu-common/docker_engine_tasks.yml"

